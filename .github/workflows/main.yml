name: Test and install package and render pkgdown website

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    container: rocker/r-ver:4.3.2
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            pandoc \
            curl \
            libxml2-dev \
            libssl-dev \
            libcurl4-openssl-dev
          apt-get clean
          rm -rf /var/lib/apt/lists/
          
      - name: Install Package Dependencies
        run: |
          Rscript -e "install.packages('remotes', repos = 'https://cran.rstudio.com/')"
          Rscript -e "remotes::install_deps(dependencies = TRUE, repos = 'https://cran.rstudio.com/')"
          
      - name: Install Package
        run: |
          R CMD INSTALL .
          
      - name: Test Package
        run: |
          Rscript -e "testthat::test_dir(path = 'tests/testthat')"
          
      - name: Render Pkgdown Site
        run: |
          Rscript -e "install.packages('pkgdown', repos = 'https://cran.rstudio.com/')"
          Rscript -e "pkgdown::build_site()"
          
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: maxheld83/ghpages@v0.2.0
        env:
          BUILD_DIR: "docs"
          GH_PAT: ${{ secrets.GH_PAT }}
